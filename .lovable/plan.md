
# Voice Chat for Poker Table (LiveKit Integration)

## Overview

Add real-time voice communication between players at the poker table, similar to Call of Duty game chat. Players can talk to each other while playing, with controls to mute their own microphone and mute all incoming audio.

## Setup Required

You will need to create a **free LiveKit Cloud account** at [livekit.io](https://livekit.io) to get two credentials:
- **LIVEKIT_API_KEY**
- **LIVEKIT_API_SECRET**

These will be stored securely as backend secrets. LiveKit Cloud's free tier supports up to 50 monthly participants, which is more than enough for poker tables.

## Architecture

Each poker table becomes a LiveKit audio room. When a player enters the table, they connect to the voice room. When they leave, they disconnect. Spectators can also listen (and optionally talk).

```text
Player A (browser)  ---\
Player B (browser)  ----}---> LiveKit Cloud (audio room = table_id)
Player C (browser)  ---/
          ^
          |
  Token generated by edge function
  (LIVEKIT_API_KEY + SECRET)
```

## Changes

### 1. New Edge Function: `livekit-token` (new file)

Generates a LiveKit room access token for the authenticated user.

- **Input:** `{ table_id: string }`
- **Output:** `{ token: string }`
- Uses `LIVEKIT_API_KEY` and `LIVEKIT_API_SECRET` to create a JWT token
- Room name = table_id (each table has its own voice room)
- Participant identity = user_id
- Grants: join room, publish audio, subscribe to audio (no video)

### 2. New Hook: `src/hooks/useVoiceChat.ts` (new file)

Custom hook that manages the LiveKit connection and audio state.

- Connects to LiveKit room using the token from the edge function
- Exposes state: `connected`, `micMuted`, `deafened`, `participants` (list of who's talking)
- Exposes actions: `connect()`, `disconnect()`, `toggleMic()`, `toggleDeafen()`
- Uses `livekit-client` SDK directly (lighter than full React components library)
- Auto-disconnects on unmount (leave table)
- Requests microphone permission on first connect

### 3. New Component: `src/components/poker/VoiceChatControls.tsx` (new file)

Compact header buttons for voice chat control.

- **Mic button:** Toggle mute/unmute your microphone (Mic / MicOff icon -- reuses existing icons)
- **Deafen button:** Toggle mute all incoming audio (Headphones / HeadphonesOff icon)
- Both are small circular buttons matching the existing header button style (w-7 h-7 rounded-full bg-white/10)
- Visual indicator: mic icon turns red/dim when muted
- On first tap, prompts for microphone permission

### 4. Modified: `src/components/poker/OnlinePokerTable.tsx`

- Import and use `useVoiceChat` hook, passing `tableId`
- Auto-connect to voice room when entering the table
- Auto-disconnect when leaving
- Add `VoiceChatControls` to the header bar (next to the sound toggle button)
- In mobile landscape dropdown menu: add "Mute Mic" and "Mute All" menu items

### 5. Modified: `src/components/poker/PlayerSeat.tsx` (minor)

- Add a small speaker/wave indicator on the player avatar when they are actively speaking (LiveKit provides `isSpeaking` per participant)
- Tiny pulsing ring or small icon overlay -- minimal visual change

## NPM Package

- `livekit-client` (the lightweight JS SDK, ~50KB gzipped -- no need for the full React components library)

## What Is NOT Changed

- Bottom navigation
- Betting controls, seat layout, game logic
- Existing sound effects and voice announcements (ElevenLabs)
- No database schema changes
- No styling/spacing changes beyond the new buttons

## Technical Details

### Edge Function Token Generation

The edge function will use LiveKit's Server SDK pattern to create a JWT access token with audio-only permissions. The token includes the user's display name so other participants see who's talking.

### Audio Management

- Voice chat audio is separate from game sounds (ElevenLabs announcements, card sounds)
- "Mute All" only mutes voice chat, not game sounds
- The existing sound toggle and voice announcements toggle remain independent

### Privacy

- Microphone starts **muted** by default -- players must actively unmute to talk
- Voice data goes through LiveKit Cloud (encrypted in transit)
- No voice data is stored or recorded
